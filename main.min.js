// ===========================================
// MAIN.JS - Código JavaScript otimizado
// ===========================================

// Configuração de performance
const config = {
    lazyLoadOffset: 100, // pixels antes da visualização
    animationThreshold: 0.1 // threshold para IntersectionObserver
};

// Estado da aplicação
const appState = {
    isPhoneVerified: false,
    isMobileMenuOpen: false,
    currentFilter: 'all'
};

// ===========================================
// INICIALIZAÇÃO
// ===========================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM carregado - iniciando otimizações...');
    
    // Marcar página como carregada
    document.body.classList.add('loaded');
    
    // Inicializar componentes
    initHeader();
    initBenefits();
    initHowItWorks();
    initClients();
    initForm();
    initFooter();
    
    // Inicializar filtros
    initFilters();
    
    // Configurar observadores para lazy loading
    setupIntersectionObservers();
    
    // Carregar fontes adicionais quando necessário
    loadAdditionalFonts();
    
    console.log('Otimizações aplicadas com sucesso!');
});

// ===========================================
// COMPONENTES
// ===========================================

function initHeader() {
    const header = document.getElementById('header');
    const mobileToggle = document.getElementById('mobileToggle');
    const navMenu = document.getElementById('navMenu');
    
    if (!header || !mobileToggle || !navMenu) return;
    
    // Scroll effect
    window.addEventListener('scroll', function() {
        if (window.scrollY > 100) {
            header.classList.add('scrolled');
        } else {
            header.classList.remove('scrolled');
        }
    }, { passive: true });
    
    // Mobile menu toggle
    mobileToggle.addEventListener('click', function() {
        appState.isMobileMenuOpen = !appState.isMobileMenuOpen;
        navMenu.classList.toggle('active');
        mobileToggle.innerHTML = appState.isMobileMenuOpen 
            ? '<i class="fas fa-times"></i>' 
            : '<i class="fas fa-bars"></i>';
    });
    
    // Close mobile menu when clicking links
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', () => {
            if (appState.isMobileMenuOpen) {
                appState.isMobileMenuOpen = false;
                navMenu.classList.remove('active');
                mobileToggle.innerHTML = '<i class="fas fa-bars"></i>';
            }
        });
    });
    
    // Smooth scroll
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href');
            if (targetId === '#') return;
            
            const targetElement = document.querySelector(targetId);
            if (targetElement) {
                window.scrollTo({
                    top: targetElement.offsetTop - 80,
                    behavior: 'smooth'
                });
            }
        });
    });
}

function initBenefits() {
    const benefitsGrid = document.querySelector('.benefits-grid');
    if (!benefitsGrid) return;
    
    const benefits = [
        {
            icon: 'fas fa-bacteria',
            title: 'Ação Antibacteriana',
            description: 'Elimina bactérias, vírus e fungos que impedem a cicatrização de feridas e úlceras.',
            type: 'primary'
        },
        {
            icon: 'fas fa-tint',
            title: 'Melhora Circulação',
            description: 'Aumenta oxigenação dos tecidos, acelerando a recuperação e reduzindo inflamações.',
            type: 'secondary'
        },
        {
            icon: 'fas fa-bolt',
            title: 'Estimula Regeneração',
            description: 'Ativa células de defesa e produção de colágeno para cicatrização mais rápida.',
            type: 'accent'
        },
        {
            icon: 'fas fa-shield-alt',
            title: 'Seguro e Natural',
            description: 'Terapia natural sem efeitos colaterais quando aplicada corretamente. Aprovado pela ANVISA.',
            type: 'primary'
        },
        {
            icon: 'fas fa-users',
            title: 'Indicado para Todas as Idades',
            description: 'Pode ser usado com segurança por crianças, adultos e idosos, adaptando protocolos conforme necessidade.',
            type: 'secondary'
        },
        {
            icon: 'fas fa-heartbeat',
            title: 'Trata Centenas de Doenças',
            description: 'Eficaz no tratamento de mais de 100 condições, de problemas dermatológicos a doenças autoimunes.',
            type: 'accent'
        }
    ];
    
    // Remover skeletons
    benefitsGrid.innerHTML = '';
    
    // Criar cards
    benefits.forEach(benefit => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <div class="card-icon ${benefit.type}">
                <i class="${benefit.icon}"></i>
            </div>
            <h3>${benefit.title}</h3>
            <p>${benefit.description}</p>
        `;
        benefitsGrid.appendChild(card);
    });
}

function initHowItWorks() {
    const stepsContainer = document.querySelector('.steps');
    if (!stepsContainer) return;
    
    const steps = [
        {
            number: '1',
            title: 'Receba o Aparelho',
            description: 'Ozoxx chega na sua casa completo, com todos os acessórios e manual de uso.'
        },
        {
            number: '2',
            title: 'Siga o Protocolo',
            description: 'Aplicamos o protocolo específico para sua condição (pé diabético, psoríase, etc.).'
        },
        {
            number: '3',
            title: 'Tenha Resultados',
            description: 'Em poucas semanas você verá a melhora. Acompanhamento com nossos especialistas.'
        }
    ];
    
    // Criar steps
    steps.forEach(step => {
        const stepElement = document.createElement('div');
        stepElement.className = 'step';
        stepElement.innerHTML = `
            <div class="step-number">${step.number}</div>
            <h3>${step.title}</h3>
            <p>${step.description}</p>
        `;
        stepsContainer.appendChild(stepElement);
    });
}

function initClients() {
    const clientsGrid = document.querySelector('.clients-grid');
    if (!clientsGrid) return;
    
    const clientImages = [
        {
            url: 'https://raw.githubusercontent.com/ozoxxvenda/ozoxx-images/refs/heads/main/casal-comprando-o-aparelho-ozoxx.webp',
            category: 'all',
            alt: 'Casal comprando Ozoxx'
        },
        {
            url: 'https://raw.githubusercontent.com/ozoxxvenda/ozoxx-images/refs/heads/main/familia-comprando-o-aparelho-ozoxx.webp',
            category: 'all psoriase',
            alt: 'Família com Ozoxx'
        },
        {
            url: 'https://raw.githubusercontent.com/ozoxxvenda/ozoxx-images/refs/heads/main/fami%CC%81lia-compra-o-Ozoxx.webp',
            category: 'all artrose',
            alt: 'Família feliz com Ozoxx'
        },
        {
            url: 'https://raw.githubusercontent.com/ozoxxvenda/ozoxx-images/refs/heads/main/fami%CC%81lia-decide-comprar-o-aparelho-ozoxx.webp',
            category: 'all dermatite',
            alt: 'Família decidindo comprar'
        },
        {
            url: 'https://raw.githubusercontent.com/ozoxxvenda/ozoxx-images/refs/heads/main/homem-compra-aparelho-ozoxx-e-fica-satisfeito.webp',
            category: 'all diabetico',
            alt: 'Homem satisfeito com Ozoxx'
        },
        {
            url: 'https://raw.githubusercontent.com/ozoxxvenda/ozoxx-images/refs/heads/main/uma-familia-comprando-o-aparelho-ozoxx.webp',
            category: 'all psoriase',
            alt: 'Outra família comprando'
        },
        {
            url: 'https://raw.githubusercontent.com/ozoxxvenda/ozoxx-images/refs/heads/main/um-senhor-de-idade-compra-o-aparelho-ozoxx.webp',
            category: 'all artrose',
            alt: 'Senhor de idade comprando'
        },
        {
            url: 'https://raw.githubusercontent.com/ozoxxvenda/ozoxx-images/refs/heads/main/ozoxx-e-seus-produtos-vendedores-vendendo.webp',
            category: 'all',
            alt: 'Produtos Ozoxx'
        },
        {
            url: 'https://raw.githubusercontent.com/ozoxxvenda/ozoxx-images/refs/heads/main/uma-senhora-compra-o-aparelho-ozoxx.webp',
            category: 'all dermatite',
            alt: 'Senhora comprando'
        },
        {
            url: 'https://raw.githubusercontent.com/ozoxxvenda/ozoxx-images/refs/heads/main/uma-senhora-idosa-comprando-o-aparelho-ozoxx.webp',
            category: 'all',
            alt: 'Senhora idosa comprando'
        },
        {
            url: 'https://raw.githubusercontent.com/ozoxxvenda/ozoxx-images/refs/heads/main/Tratamento-com-aparelho-ozoxx-Muitas-dores-Joelhos-Bico-de-Papagaio-Glaucoma-Ca%CC%83imbras.webp',
            category: 'all diabetico',
            alt: 'Tratamento com aparelho Ozoxx'
        },
        {
            url: 'https://raw.githubusercontent.com/ozoxxvenda/ozoxx-images/refs/heads/main/Tratamento-com-ozonio-usando-aparelho-ozoxx.webp',
            category: 'all psoriase artrose',
            alt: 'Tratamento com ozônio'
        },
        {
            url: 'https://raw.githubusercontent.com/ozoxxvenda/ozoxx-images/refs/heads/main/familia-comprando-aparelho-ozoxx.webp',
            category: 'all dermatite',
            alt: 'Família comprando aparelho'
        },
        {
            url: 'https://raw.githubusercontent.com/ozoxxvenda/ozoxx-images/refs/heads/main/mais-uma-familia-compra-aparelho-ozoxx.webp',
            category: 'all',
            alt: 'Mais uma família compra aparelho'
        }
    ];
    
    // Remover skeletons
    clientsGrid.innerHTML = '';
    
    // Criar cards com lazy loading
    clientImages.forEach((image, index) => {
        const card = document.createElement('div');
        card.className = 'client-card';
        card.setAttribute('data-category', image.category);
        
        if (index < 4) {
            // Primeiras 4 imagens carregam imediatamente
            card.innerHTML = `
                <img src="${image.url}" alt="${image.alt}" class="client-image" loading="lazy" width="400" height="280">
            `;
        } else {
            // Restante carrega com placeholder
            card.innerHTML = `
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='280'%3E%3Crect width='100%25' height='100%25' fill='%23f0f0f0'/%3E%3C/svg%3E"
                     data-src="${image.url}"
                     alt="${image.alt}"
                     class="client-image lazy"
                     width="400"
                     height="280">
            `;
        }
        
        clientsGrid.appendChild(card);
    });
}

function initForm() {
    const contactForm = document.getElementById('contactForm');
    if (!contactForm) return;
    
    // Remover loading
    contactForm.innerHTML = '';
    
    // Criar formulário
    contactForm.innerHTML = `
        <div class="form-grid">
            <div class="form-group">
                <label for="name" class="form-label">Nome Completo *</label>
                <input type="text" id="name" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="phone" class="form-label">Telefone/WhatsApp *</label>
                <input type="tel" id="phone" class="form-control" required placeholder="(11) 99999-9999">
                <small style="display: block; margin-top: 5px; color: var(--gray);">Verificação obrigatória via WhatsApp</small>
            </div>
            
            <div class="form-group">
                <label for="email" class="form-label">E-mail</label>
                <input type="email" id="email" class="form-control" placeholder="seu@email.com">
            </div>
            
            <div class="form-group">
                <label for="age" class="form-label">Idade *</label>
                <input type="number" id="age" class="form-control" required min="1" max="120">
            </div>
            
            <div class="form-group">
                <label for="state" class="form-label">Estado *</label>
                <select id="state" class="form-control form-select" required>
                    <option value="">Selecione seu estado</option>
                    <option value="SP">São Paulo</option>
                    <option value="RJ">Rio de Janeiro</option>
                    <option value="MG">Minas Gerais</option>
                    <option value="RS">Rio Grande do Sul</option>
                    <option value="PR">Paraná</option>
                    <option value="SC">Santa Catarina</option>
                    <option value="BA">Bahia</option>
                    <option value="PE">Pernambuco</option>
                    <option value="CE">Ceará</option>
                    <option value="DF">Distrito Federal</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="city" class="form-label">Cidade *</label>
                <input type="text" id="city" class="form-control" required>
            </div>
            
            <div class="form-group full-width">
                <label for="condition" class="form-label">Condição de Saúde (Opcional)</label>
                <select id="condition" class="form-control form-select">
                    <option value="">Selecione sua condição</option>
                    <option value="diabetico">Pé Diabético</option>
                    <option value="psoriase">Psoríase</option>
                    <option value="artrose">Artrose</option>
                    <option value="dermatite">Dermatite</option>
                    <option value="outra">Outra</option>
                </select>
            </div>
            
            <div class="form-group full-width">
                <label for="message" class="form-label">Conte mais sobre seu caso (Opcional)</label>
                <textarea id="message" class="form-control" rows="4" placeholder="Há quanto tempo sofre com isso? Quais tratamentos já tentou?"></textarea>
            </div>
        </div>
        
        <div class="form-checkbox">
            <input type="checkbox" id="privacy" required>
            <label for="privacy">Concordo com a Política de Privacidade e autorizo o contato via WhatsApp</label>
        </div>
        
        <div id="verificationStatus" class="verification-status"></div>
        
        <button type="submit" class="btn btn-primary btn-lg btn-block">
            <i class="fas fa-paper-plane"></i> Enviar Solicitação
        </button>
    `;
    
    // Inicializar funcionalidades do formulário
    initFormFunctionalities();
}

function initFooter() {
    const footerGrid = document.querySelector('.footer-grid');
    if (!footerGrid) return;
    
    footerGrid.innerHTML = `
        <div class="footer-about">
            <div class="footer-logo">
                <img src="https://ozoxx.com.br/wp-content/uploads/2023/01/LOGO-OZOXX-1.png" alt="Ozoxx" width="180" height="60" loading="lazy">
            </div>
            <p>Ozoxx é o primeiro aparelho de ozonioterapia caseira do Brasil, desenvolvido para oferecer saúde, bem-estar e qualidade de vida através da terapia com ozônio medicinal.</p>
        </div>
        
        <div class="footer-links">
            <h4 class="footer-title">Links Rápidos</h4>
            <ul>
                <li><a href="#home"><i class="fas fa-chevron-right"></i> Início</a></li>
                <li><a href="#benefits"><i class="fas fa-chevron-right"></i> Benefícios</a></li>
                <li><a href="#how-it-works"><i class="fas fa-chevron-right"></i> Como Funciona</a></li>
                <li><a href="#clients"><i class="fas fa-chevron-right"></i> Resultados</a></li>
                <li><a href="#testimonials"><i class="fas fa-chevron-right"></i> Depoimentos</a></li>
                <li><a href="#contact"><i class="fas fa-chevron-right"></i> Contato</a></li>
            </ul>
        </div>
        
        <div class="footer-contact">
            <h4 class="footer-title">Contato</h4>
            <ul class="footer-links">
                <li>
                    <a href="tel:+5511999999999">
                        <i class="fas fa-phone"></i> (11) 99999-9999
                    </a>
                </li>
                <li>
                    <a href="mailto:ozoxx.venda@gmail.com">
                        <i class="fas fa-envelope"></i> ozoxx.venda@gmail.com
                    </a>
                </li>
                <li>
                    <a href="https://wa.me/5511999999999" target="_blank">
                        <i class="fab fa-whatsapp"></i> (11) 99999-9999
                    </a>
                </li>
            </ul>
        </div>
    `;
    
    // Adicionar footer bottom
    const footerBottom = document.createElement('div');
    footerBottom.className = 'footer-bottom';
    footerBottom.innerHTML = `
        <p>© 2023 Ozoxx - Ozonioterapia Caseira. Todos os direitos reservados.</p>
        <p>Registro ANVISA: xxxxxx. Este site não faz parte do Google ou Facebook.</p>
    `;
    footerGrid.parentElement.appendChild(footerBottom);
}

// ===========================================
// FILTROS
// ===========================================

function initFilters() {
    const filterButtons = document.querySelectorAll('.filter-btn');
    const clientCards = document.querySelectorAll('.client-card');
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Update active button
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            const filter = this.getAttribute('data-filter');
            appState.currentFilter = filter;
            
            // Filter cards with animation
            clientCards.forEach(card => {
                if (filter === 'all' || card.getAttribute('data-category').includes(filter)) {
                    card.style.display = 'block';
                    setTimeout(() => {
                        card.style.opacity = '1';
                        card.style.transform = 'scale(1)';
                    }, 10);
                } else {
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.8)';
                    setTimeout(() => {
                        card.style.display = 'none';
                    }, 300);
                }
            });
        });
    });
    
    // Ativar primeiro filtro
    document.querySelector('.filter-btn[data-filter="all"]')?.click();
}

// ===========================================
// FUNCIONALIDADES DO FORMULÁRIO
// ===========================================

function initFormFunctionalities() {
    const contactForm = document.getElementById('contactForm');
    const phoneInput = document.getElementById('phone');
    
    if (!contactForm || !phoneInput) return;
    
    // Formatação automática do telefone
    phoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 11) value = value.substring(0, 11);
        
        if (value.length > 10) {
            e.target.value = `(${value.substring(0,2)}) ${value.substring(2,7)}-${value.substring(7,11)}`;
        } else if (value.length > 6) {
            e.target.value = `(${value.substring(0,2)}) ${value.substring(2,6)}-${value.substring(6,10)}`;
        } else if (value.length > 2) {
            e.target.value = `(${value.substring(0,2)}) ${value.substring(2)}`;
        } else if (value.length > 0) {
            e.target.value = `(${value}`;
        }
    });
    
    // Submissão do formulário
    contactForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!appState.isPhoneVerified) {
            const verificationStatus = document.getElementById('verificationStatus');
            verificationStatus.className = 'verification-status error';
            verificationStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Por favor, verifique seu número de telefone primeiro.';
            verificationStatus.style.display = 'block';
            phoneInput.focus();
            return;
        }
        
        // Coletar dados do formulário
        const formData = {
            name: document.getElementById('name').value,
            phone: document.getElementById('phone').value,
            email: document.getElementById('email').value,
            age: document.getElementById('age').value,
            state: document.getElementById('state').value,
            city: document.getElementById('city').value,
            condition: document.getElementById('condition').value,
            message: document.getElementById('message').value,
            timestamp: new Date().toLocaleString('pt-BR')
        };
        
        // Simular envio
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
        submitBtn.disabled = true;
        
        setTimeout(() => {
            // Sucesso
            const verificationStatus = document.getElementById('verificationStatus');
            verificationStatus.className = 'verification-status success';
            verificationStatus.innerHTML = `
                <i class="fas fa-check-circle"></i> 
                <strong>Solicitação enviada com sucesso!</strong><br>
                Entraremos em contato em até 24 horas pelo WhatsApp.
            `;
            verificationStatus.style.display = 'block';
            
            // Reset do formulário
            contactForm.reset();
            appState.isPhoneVerified = false;
            
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            
            // Scroll para o status
            verificationStatus.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 1500);
    });
}

// ===========================================
// LAZY LOADING E OBSERVERS
// ===========================================

function setupIntersectionObservers() {
    // Observador para lazy loading de imagens
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                const src = img.getAttribute('data-src');
                
                if (src) {
                    img.src = src;
                    img.classList.remove('lazy');
                    observer.unobserve(img);
                }
            }
        });
    }, {
        rootMargin: `${config.lazyLoadOffset}px`,
        threshold: config.animationThreshold
    });
    
    // Observar todas as imagens lazy
    document.querySelectorAll('img.lazy').forEach(img => {
        imageObserver.observe(img);
    });
    
    // Observador para animações
    const animationObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('animated');
            }
        });
    }, {
        threshold: config.animationThreshold
    });
    
    // Observar elementos para animação
    document.querySelectorAll('.non-critical').forEach(el => {
        animationObserver.observe(el);
    });
}

// ===========================================
// OTIMIZAÇÕES ADICIONAIS
// ===========================================

function loadAdditionalFonts() {
    // Carregar Font Awesome apenas quando necessário (mobile já carregou condicionalmente)
    if (window.innerWidth <= 768) {
        const faLink = document.createElement('link');
        faLink.rel = 'stylesheet';
        faLink.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css';
        faLink.integrity = 'sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==';
        faLink.crossOrigin = 'anonymous';
        faLink.referrerPolicy = 'no-referrer';
        document.head.appendChild(faLink);
    }
}

// ===========================================
// UTILITÁRIOS DE PERFORMANCE
// ===========================================

// Debounce para eventos
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Throttle para eventos
function throttle(func, limit) {
    let inThrottle;
    return function() {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    };
}

// ===========================================
// MANIPULAÇÃO DE ERROS
// ===========================================

window.addEventListener('error', function(e) {
    console.error('Erro capturado:', e.error);
    // Aqui você poderia enviar para um serviço de monitoramento
});

window.addEventListener('unhandledrejection', function(e) {
    console.error('Promise rejeitada não tratada:', e.reason);
});

// ===========================================
// SERVICE WORKER (se implementado)
// ===========================================

if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js').then(function(registration) {
            console.log('ServiceWorker registrado com sucesso: ', registration.scope);
        }, function(err) {
            console.log('Falha ao registrar ServiceWorker: ', err);
        });
    });
}

// ===========================================
// EXPORTAR PARA USO GLOBAL (se necessário)
// ===========================================

window.appState = appState;
window.config = config;
