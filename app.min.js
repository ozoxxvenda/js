// APENAS 1.5KB MINIFICADO
class LeadCapture {
    constructor() {
        this.metrics = {
            pageStart: Date.now(),
            interactions: 0,
            fieldFocus: 0
        };
        this.init();
    }

    init() {
        // Eventos delegados para performance
        document.addEventListener('focusin', this.trackFocus.bind(this), { passive: true });
        document.addEventListener('input', this.debounce(this.trackInput.bind(this), 300), { passive: true });
        
        // Form submission
        const form = document.getElementById('leadForm');
        form.addEventListener('submit', this.handleSubmit.bind(this));
        
        // PrÃ©-carregar recursos apÃ³s carregamento inicial
        window.addEventListener('load', () => this.preloadResources());
    }

    // Debounce para reduzir chamadas
    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    trackFocus(e) {
        if (e.target.tagName === 'INPUT') {
            this.metrics.fieldFocus++;
            // Salva metricas de forma nÃ£o-bloqueante
            requestIdleCallback(() => {
                localStorage.setItem('fieldFocus', this.metrics.fieldFocus);
            });
        }
    }

    trackInput() {
        this.metrics.interactions++;
    }

    async handleSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const data = new FormData(form);
        
        // ValidaÃ§Ã£o rÃ¡pida
        if (!this.validateForm(data)) return;
        
        // UI feedback imediato (nÃ£o bloqueante)
        this.showLoading(true);
        
        try {
            // Enviar dados (nÃ£o-bloqueante)
            const success = await this.sendData(data);
            
            if (success) {
                // Redirecionamento otimizado
                this.redirectToMainSite();
            }
        } catch (error) {
            this.showError('Erro ao processar. Tente novamente.');
            this.showLoading(false);
        }
    }

    validateForm(data) {
        const nome = data.get('nome')?.trim();
        const telefone = data.get('telefone')?.trim();
        
        if (!nome || !telefone) {
            this.showError('Nome e telefone sÃ£o obrigatÃ³rios');
            return false;
        }
        
        // ValidaÃ§Ã£o simples de email (se preenchido)
        const email = data.get('email')?.trim();
        if (email && !this.isValidEmail(email)) {
            this.showError('Email invÃ¡lido');
            return false;
        }
        
        return true;
    }

    isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    async sendData(data) {
        const payload = {
            nome: data.get('nome'),
            telefone: data.get('telefone'),
            email: data.get('email'),
            ts: Date.now(),
            perf: {
                loadTime: Date.now() - this.metrics.pageStart,
                interactions: this.metrics.interactions
            }
        };

        // Tenta enviar para Google Sheets
        try {
            return await this.sendToGoogleSheets(payload);
        } catch (error) {
            // Fallback para localStorage
            this.saveToLocalStorage(payload);
            return true; // Continua mesmo sem internet
        }
    }

    async sendToGoogleSheets(data) {
        // URL do seu Google Apps Script
        const SCRIPT_URL = 'https://script.google.com/macros/s/.../exec';
        
        // Usando Beacon API para envio nÃ£o-bloqueante
        const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
        
        if (navigator.sendBeacon) {
            navigator.sendBeacon(SCRIPT_URL, blob);
            return true;
        } else {
            // Fallback para fetch com prioridade baixa
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);
            
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: blob,
                signal: controller.signal,
                keepalive: true // MantÃ©m a requisiÃ§Ã£o mesmo apÃ³s navegaÃ§Ã£o
            });
            
            clearTimeout(timeoutId);
            return response.ok;
        }
    }

    saveToLocalStorage(data) {
        requestIdleCallback(() => {
            const leads = JSON.parse(localStorage.getItem('leads') || '[]');
            leads.push({ ...data, storedAt: new Date().toISOString() });
            localStorage.setItem('leads', JSON.stringify(leads.slice(-100))); // MantÃ©m apenas Ãºltimos 100
        });
    }

    showLoading(show) {
        const btn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');
        
        if (show) {
            btn.disabled = true;
            btn.textContent = 'Processando...';
            loading.style.display = 'block';
        } else {
            btn.disabled = false;
            btn.textContent = 'ðŸ‘‰ Acessar Agora';
            loading.style.display = 'none';
        }
    }

    showError(message) {
        // Toast nÃ£o-bloqueante
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#ff4444;color:white;padding:10px 20px;border-radius:5px;z-index:1000;';
        document.body.appendChild(toast);
        
        setTimeout(() => toast.remove(), 3000);
    }

    redirectToMainSite() {
        // Salva sessÃ£o e redireciona
        localStorage.setItem('formCompleted', 'true');
        localStorage.setItem('userAccess', Date.now());
        
        // Redirecionamento suave
        window.location.href = 'home.html';
    }

    preloadResources() {
        // PrÃ©-carrega recursos para a prÃ³xima pÃ¡gina
        if ('connection' in navigator && navigator.connection.saveData === false) {
            const link = document.createElement('link');
            link.rel = 'prefetch';
            link.href = 'home.html';
            document.head.appendChild(link);
        }
    }
}

// Inicializa quando DOM estiver pronto
document.addEventListener('DOMContentLoaded', () => {
    new LeadCapture();
});

// Coleta mÃ©tricas de performance
if ('PerformanceObserver' in window) {
    const observer = new PerformanceObserver((list) => {
        for (const entry of list.getEntries()) {
            if (entry.name === 'first-contentful-paint') {
                console.log('FCP:', entry.startTime);
                localStorage.setItem('fcp', entry.startTime);
            }
        }
    });
    observer.observe({ entryTypes: ['paint'] });
}
