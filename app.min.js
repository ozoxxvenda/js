class LeadCapture {
    constructor() {
        this.m = {s: Date.now(), f: 0};
        this.init();
    }

    init() {
        // Eventos passivos (performance)
        document.addEventListener('focusin', e => {
            if (e.target.tagName === 'INPUT') this.m.f++;
        }, {passive: true});

        const f = document.getElementById('leadForm');
        if (!f) return;
        
        f.addEventListener('submit', e => this.hs(e));
        
        // Honeypot anti-bots (SEO)
        const hp = document.createElement('input');
        hp.type = 'text';
        hp.name = 'h';
        hp.style.cssText = 'opacity:0;position:absolute;left:-9999px;';
        hp.tabIndex = -1;
        f.appendChild(hp);
    }

    async hs(e) {
        e.preventDefault();
        const f = e.target;
        const d = new FormData(f);
        
        // Anti-spam
        if (d.get('h')) return;
        
        const n = d.get('nome')?.trim();
        const t = d.get('tel')?.trim();
        const e = d.get('email')?.trim();
        
        if (!n || !t) {
            this.err('Nome e telefone obrigatórios');
            return;
        }
        
        if (e && !this.validEmail(e)) {
            this.err('Email inválido');
            return;
        }
        
        // UI feedback
        const b = document.getElementById('submitBtn');
        const ot = b.textContent;
        b.disabled = true;
        b.textContent = 'Processando...';
        b.setAttribute('aria-busy', 'true');
        
        try {
            // Timeout + abort
            const c = new AbortController();
            const to = setTimeout(() => c.abort(), 8000);
            
            await fetch('https://script.google.com/macros/s/AKfycbzLzYlNzHG2z1snKMpi70xuGCVv9xN7WtKxMcK_ChKexeK_phXdmlHajD14Vcb2FIzz/exec', {
                method: 'POST',
                body: JSON.stringify({
                    n: this.san(n),
                    t: this.san(t),
                    e: e ? this.san(e) : '',
                    ts: new Date().toISOString(),
                    r: document.referrer || 'direct',
                    ua: navigator.userAgent.substring(0, 100)
                }),
                keepalive: true,
                signal: c.signal
            });
            
            clearTimeout(to);
            
            // Sucesso
            localStorage.setItem('fc', '1');
            localStorage.setItem('fts', Date.now());
            
            // Redireciona
            location.href = 'home.html';
            
        } catch {
            this.err('Erro. Tente novamente.');
            b.disabled = false;
            b.textContent = ot;
            b.setAttribute('aria-busy', 'false');
        }
    }

    san(t) {
        return t.toString()
            .replace(/[<>]/g, '')
            .substring(0, 200);
    }

    validEmail(e) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);
    }

    err(m) {
        const el = document.createElement('div');
        el.textContent = m;
        el.style.cssText = 'background:#f56565;color:white;padding:10px;margin:10px 0;border-radius:4px;font-size:14px;';
        el.setAttribute('role', 'alert');
        
        const f = document.getElementById('leadForm');
        f.prepend(el);
        
        setTimeout(() => el.remove(), 4000);
    }
}

// Inicialização otimizada
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => new LeadCapture());
} else {
    new LeadCapture();
}
